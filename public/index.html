<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel・CSV変換ツール</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>データ変換システム</h1>
            <p>Excelを取り込み、データを統合してCSVを出力します</p>
        </header>

        <div class="card">
            <div class="card-header">
                <span class="step-badge">STEP 1</span>
                <h2>Excelファイルを選択</h2>
            </div>
            
            <div class="upload-area" id="dropZone">
                <input type="file" id="uploadFile" accept=".xlsx">
                <div class="upload-content">
                    <svg class="excel-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="#217346" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                    <p class="upload-text">ここにExcelファイルをドロップ<br>または <span>クリックして選択</span></p>
                    <p id="fileNameDisplay" class="file-name"></p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="step-badge">STEP 2</span>
                <h2>データの貼り付け</h2>
            </div>
            <p class="instruction">枠内の左上をクリックし、データを貼り付けてください (Ctrl+V)</p>
            
            <div class="table-container">
                <table id="inputTable">
                    <thead>
                        <tr>
                            <th>お子さま</th>
                            <th>フリガナ</th>
                            <th>性別</th>
                            <th>年齢</th>
                            <th>生年月日</th>
                            <th>保護者</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="action-area">
            <button id="convertBtn" onclick="processData()">
                CSVに変換してダウンロード
            </button>
            <div id="statusMessage"></div>
            <a id="downloadLink" style="display:none;"></a>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // ファイル選択時の名前表示ロジック
        document.getElementById('uploadFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "";
            document.getElementById('fileNameDisplay').textContent = fileName;
            if(fileName) {
                document.querySelector('.upload-area').classList.add('has-file');
            }
        });

        // 変換＆ダウンロード処理（修正版）
        async function processData() {
            const fileInput = document.getElementById('uploadFile');
            const convertBtn = document.getElementById('convertBtn');
            const statusMsg = document.getElementById('statusMessage');
            const downloadLink = document.getElementById('downloadLink');

            // 1. ファイルチェック
            if (!fileInput.files[0]) {
                alert('Excelファイルを選択してください。');
                return;
            }

            // 2. 表データの取得
            const tableData = [];
            const rows = document.querySelectorAll('#inputTable tbody tr');
            rows.forEach(tr => {
                const rowValues = [];
                let hasData = false;
                tr.querySelectorAll('input').forEach(input => {
                    rowValues.push(input.value);
                    if(input.value.trim() !== "") hasData = true;
                });
                // 空行はスキップする場合はここを有効化
                // if (hasData) tableData.push(rowValues);
                tableData.push(rowValues);
            });

            // 3. 送信データの作成
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('tableData', JSON.stringify(tableData));

            // UI更新
            convertBtn.disabled = true;
            statusMsg.textContent = "CSVを作成中...";
            downloadLink.style.display = 'none';

            try {
                // 4. APIへ送信
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error('サーバーエラー: ' + errText);
                }

                // 5. ファイルダウンロード処理
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // ★ここが重要：今日の日付で .csv ファイル名を作る
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const filename = `complete_${year}${month}${day}.csv`;
                
                downloadLink.href = url;
                downloadLink.download = filename; // 拡張子を .csv に強制
                downloadLink.textContent = `ダウンロード (${filename})`;
                downloadLink.style.display = 'inline-block';
                
                // ダウンロードボタンの見た目をリセット
                downloadLink.style.backgroundColor = '#217346'; 
                downloadLink.style.color = '#fff';
                
                statusMsg.textContent = "作成完了！下のボタンを押して保存してください。";

            } catch (error) {
                console.error(error);
                statusMsg.textContent = "エラーが発生しました: " + error.message;
                statusMsg.style.color = "red";
            } finally {
                convertBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
